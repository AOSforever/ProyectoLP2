
### BASE DE DATOS - FARMACIA

DROP DATABASE IF EXISTS BD_PHARMACY;

CREATE DATABASE BD_PHARMACY;
USE BD_PHARMACY;

CREATE TABLE CUSTOMER(
	CUS_ID			INT PRIMARY KEY AUTO_INCREMENT,
	CUS_DNI 		CHAR(8) NOT NULL,
	CUS_NAME		VARCHAR(40) NOT NULL,
	CUS_LAST_NAME	VARCHAR(40) NOT NULL,
	CUS_PHONE		VARCHAR(12),

	CONSTRAINT CK_NAME_LENGTH CHECK( CHAR_LENGTH(CUS_NAME) > 5 ),
	CONSTRAINT CK_PHONE_LEGTH CHECK( CHAR_LENGTH(CUS_PHONE) >= 9 ),
	CONSTRAINT CK_DNI_LENGTH CHECK( CHAR_LENGTH(CUS_DNI) = 8 )
);

ALTER TABLE CUSTOMER MODIFY CUS_DNI CHAR(8) NOT NULL UNIQUE;

CREATE TABLE EMPLOYEE(
	EMP_ID			INT AUTO_INCREMENT PRIMARY KEY,
	EMP_DNI			CHAR(8) NOT NULL UNIQUE,
	EMP_NAME		VARCHAR(40) NOT NULL,
	EMP_LAS_NAME	VARCHAR(40) NOT NULL,
	EMP_PHONE		VARCHAR(12) NOT NULL,
	EMP_EMAIL		VARCHAR(40) NOT NULL,
	EMP_ADDRESS		VARCHAR(40) NOT NULL,
	EMP_USER_TYPE		CHAR(20) NOT NULL,
	EMP_USER_NAME		VARCHAR(20) NOT NULL UNIQUE,
	EMP_USER_PSW		VARCHAR(20) NOT NULL,
	EMP_USER_PROFILE	LONGBLOB,

	CONSTRAINT CK_PSW_USER CHECK( CHAR_LENGTH(EMP_USER_PSW) BETWEEN 5 AND  20),
	CONSTRAINT CK_PHONE_LEGTH CHECK( CHAR_LENGTH(EMP_PHONE) >= 9 ),
	CONSTRAINT CK_DNI_LENGTH CHECK( CHAR_LENGTH(EMP_DNI) = 8 ),
	CONSTRAINT CK_NAME CHECK( CHAR_LENGTH(EMP_NAME) > 5 )
);
-- SHOW CREATE TABLE EMPLOYEE;
ALTER TABLE EMPLOYEE MODIFY EMP_DNI CHAR(8) NOT NULL UNIQUE;
ALTER TABLE EMPLOYEE MODIFY EMP_USER_NAME VARCHAR(20) NOT NULL UNIQUE;
-- ALTER TABLE EMPLOYEE ADD CONSTRAINT CK_PSW_USER CHECK( CHAR_LENGTH(EMP_USER_PSW) BETWEEN 5 AND 20 );

CREATE TABLE SUPPLIER(
	SUP_ID			INT AUTO_INCREMENT PRIMARY KEY,
	SUP_RUC			CHAR(11) NOT NULL,
	SUP_NAME		VARCHAR(40) NOT NULL,
	SUP_PHONE		CHAR(9) NOT NULL,
	SUP_ADDRESS		VARCHAR(40) NOT NULL,
	SUB_WEB_LINK	VARCHAR(40) NULL,

	CONSTRAINT CK_WEB_LINK CHECK( LEFT(SUB_WEB_LINK,4) = 'http' ),
	CONSTRAINT CK_PHONE_LENGTH CHECK( CHAR_LENGTH(SUP_PHONE) >= 9 ),
	CONSTRAINT CK_NAME CHECK( CHAR_LENGTH(SUP_NAME) > 5 ),
	CONSTRAINT CK_RUC CHECK( CHAR_LENGTH(SUP_RUC) = 11 )
);

ALTER TABLE SUPPLIER MODIFY SUP_RUC CHAR(11) NOT NULL UNIQUE;

CREATE TABLE CATEGORY(
	CAT_ID 		INT AUTO_INCREMENT PRIMARY KEY,
	CAT_NAME	VARCHAR(40) NOT NULL
);

CREATE TABLE PRODUCT(
	PROD_ID				INT AUTO_INCREMENT PRIMARY KEY,
	CAT_ID 				INT NOT NULL,
	PROD_NAME 			VARCHAR(30) NOT NULL,
	PROD_STOK_MIN 		INT NOT NULL,
	PROD_STOCK_MAX 		INT NOT NULL,
	PROD_STOCK			INT NOT NULL,
	PROD_DESC 			VARCHAR(20),
	PROD_UNIT_PUR_PRICE 	DECIMAL(10,2) NOT NULL,
	PROD_UNIT_SALE_PRICE 	DECIMAL(10,2) NOT NULL,

	FOREIGN KEY(CAT_ID) REFERENCES CATEGORY(CAT_ID),
	CONSTRAINT CK_STOCK_LENGTH CHECK( PROD_STOCK >= 0 ),
	CONSTRAINT CK_NAME CHECK( CHAR_LENGTH(PROD_NAME) > 5 )
);

ALTER TABLE PRODUCT MODIFY PROD_NAME VARCHAR(30) NOT NULL UNIQUE;

CREATE TABLE RECEIPT(
	REC_ID			INT AUTO_INCREMENT PRIMARY KEY,
	CUS_ID			INT NOT NULL,
	EMP_ID			INT NOT NULL,
	REC_PAYMENT_MT	ENUM('CREDITO','DEBITO','EFECTIVO') NOT NULL,
	REC_DATE_ISSUE	DATE,

	FOREIGN KEY (CUS_ID) REFERENCES CUSTOMER(CUS_ID),
	FOREIGN KEY (EMP_ID) REFERENCES EMPLOYEE(EMP_ID)	
);

CREATE TABLE RECEIPT_DETAILS(
	REC_ID 			INT NOT NULL,
	PROD_ID	 		INT NOT NULL,
	PROD_UNIT_PRICE DOUBLE(10,2) NOT NULL,
	RD_AMOUNT_PROD SMALLINT NOT NULL,

	FOREIGN KEY (REC_ID) REFERENCES RECEIPT(REC_ID),
	FOREIGN KEY (PROD_ID) REFERENCES PRODUCT(PROD_ID),

	PRIMARY KEY (REC_ID, PROD_ID)
);

CREATE TABLE SUPPLIER_INVOICE(
	INV_ID		INT AUTO_INCREMENT PRIMARY KEY,
	SUP_ID 		INT NOT NULL,
	EMP_ID		INT NOT NULL,
	INV_DATE_ISSUE		DATE,
	INV_PAYMENT_METHOD	ENUM('CREDITO','DEBITO','EFECTIVO'),

	FOREIGN KEY (SUP_ID) REFERENCES SUPPLIER(SUP_ID),
	FOREIGN KEY (EMP_ID) REFERENCES EMPLOYEE(EMP_ID)
);

CREATE TABLE SUPPLIER_INVOICE_DETAILS(
	INV_ID			INT NOT NULL,
	PROD_ID			INT NOT NULL,
	INV_AMOUNT_PROD INT NOT NULL,
	PROD_UNIT_PRICE	DECIMAL(10,2) NOT NULL,

	FOREIGN KEY (INV_ID) REFERENCES	SUPPLIER_INVOICE(INV_ID),
	FOREIGN KEY (PROD_ID) REFERENCES PRODUCT(PROD_ID),
	PRIMARY KEY (INV_ID, PROD_ID)
);

